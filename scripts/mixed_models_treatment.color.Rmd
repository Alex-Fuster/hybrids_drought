---
title: "Mixed models - flower color and treatmenr"
output: html_notebook
---

This script conducts analyses to test the effect of treatment (control, early drought and late drought) and color or phenotype (A.m. pseudomajus, F1 hybrids, and A.m. striatum) on individual trait responses.



Load packages

```{r, results="hide", message=FALSE, waring = FALSE}


## load required packages
pkgs <- c("lme4", 
           
          "multcomp", 
           
          "lsmeans", 
          "tidyverse",
          
          "tidyverse", 
          "dplyr",
          #"effsize",
          #"hrbrthemes", 
          "viridis", 
          #"plyr", 
         # "cowplot", 
         # "aods3", 
         # "AER", 
         # "pscl",
          "DHARMa", 
         # "plotly",
          "ggpubr", 
         # "extrafont",
          "car", 
          "rcompanion", 
         # "agricolae",
        #  "jtools", 
        #  "sjPlot", 
         # "VGAM", 
         # "pracma",
        #  "rgl",
          "MASS", 
         # "performance", 
         # "brms", 
        #  "sjstats", 
        #  "sjmisc",
         #"lmerTest",
         #"rockchalk",
          "emmeans", 
         #"afex",
         #"effects",
         "forcats", 
      #    "visreg", 
      #  "rstatix", 
         #"lmerTest",
          #"ggstance", 
         #"broomExtra",
     # "grid",
         "glmmTMB",
      #   "ggeffects",
         "patchwork"
     )


lapply(pkgs, library, character.only = TRUE)

rm(pkgs)
```


### Read data

the dataset used for the analyses is computed in **"compute_df_analyses.Rmd"**.

```{r}

Dataset <- read.csv("../dataset.csv")

# Filter to conduct analysis only for individuals resulted from between population crosses (discard within pop crosses)

Dataset <- Dataset %>% 
  filter(w_b == "b") 

# Set random effects as factors

Dataset$block <- as.factor(Dataset$block)
Dataset$cross <- as.factor(Dataset$cross)

Dataset$bushiness[Dataset$bushiness==0] <- NA

head(Dataset)

```

Create a dataset excluding control to run the survival model:

```{r}
Dataset_nc<-subset(Dataset, Dataset$trt != "control") #Dataset used for the model with survival as response variable
```


## Fitted models


```{r}

glmer_surv_nc <- glmmTMB(survived~ trt + colors + trt:colors + (1|block) +(1|cross), family = "binomial", data = 
                         Dataset_nc)

glmer_f <- glmmTMB(flowering~trt + colors + trt:colors + (1|block) +(1|cross), family = "binomial", data = Dataset)

glmer_nf_d <- glmmTMB(flower_count ~ trt + colors + trt:colors, data = Dataset, family = "nbinom2")


lmer_height<-lmer(height_cm~trt + colors + trt:colors + (1|block) +(1|cross), Dataset, na.action=na.exclude)
lmer_height.o<-lmer(height_cm~trt + colors + trt:colors + (1|block)+(1|cross), Dataset, na.action=na.omit) # This model only changes the na.action because packages used for diagnostics cant handle na.exclude() and some plotting functions handle na.omit() better. This does not affect any estimate and both models are equivalent as both na.exclude and na.omit remove the row where any of the dependent or independent variable is missing


glmer_bush <- glmmTMB(bushiness~ trt + colors + trt:colors + (1|block)+(1|cross), data = Dataset, family = "poisson")


glmer_tf <- glmmTMB(days_1flower~trt + colors + trt:colors + (1|block) +(1|cross), family = "nbinom2", data = Dataset)

```


## Model evaluations

```{r}

# Survival

simulationOutput_surv_d<-simulateResiduals(glmer_surv_nc) 
dharma_plot_surv<-plot(simulationOutput_surv_d)
surv_dharma<-testResiduals(simulationOutput_surv_d)


# Flowering

simulationOutput_flow<-simulateResiduals(glmer_f) 
dharma_plot_flow<-plot(simulationOutput_flow)
flow_dharma<-testResiduals(simulationOutput_flow) 


# flower_count


simulationOutput_nflow<-simulateResiduals(glmer_nf_d) 
dharma_plot_nflow<-plot(simulationOutput_nflow)



# Height

simulationOutput_height_d<-simulateResiduals(lmer_height.o)
dharma_plot_height<-plot(simulationOutput_height_d)
height_dharma<-testResiduals(simulationOutput_height_d)


# Bushiness

simulationOutput_bush_d<-simulateResiduals(glmer_bush)
dharma_plot_bush<-plot(simulationOutput_bush_d)
bush_dharma<-testResiduals(simulationOutput_bush_d) 


# t flower

simulationOutput_tflow_d<-simulateResiduals(glmer_tf)
dharma_plot_tflow<-plot(simulationOutput_tflow_d)
tflow_dharma<-testResiduals(simulationOutput_tflow_d)


```



## Summary Anova tables

```{r}

s_surv<-car::Anova(glmer_surv_nc,type="II")
s_flow<-car::Anova(glmer_f,type="II")
s_nflow<-car::Anova(glmer_nf_d,type="II")
s_height<-car::Anova(lmer_height,type="III")
s_bush<-car::Anova(glmer_bush,type="III")
s_tflow<-car::Anova(glmer_tf,type="III")
#s_iheight<-car::Anova(lm_iheight_col,type="III")

options(scipen = 999)

surv<-as.data.frame(s_surv)
colnames(surv)[1] <- "Chisq"
surv <- cbind(surv,rep("survival", nrow(surv)))
colnames(surv)[ncol(surv)] = "trait"

flow<-as.data.frame(s_flow)
colnames(flow)[1] <- "Chisq"
flow <- cbind(flow,rep("flowering", nrow(flow)))
colnames(flow)[ncol(flow)] = "trait"


nflow<-as.data.frame(s_nflow)
nflow <- cbind(nflow,rep("n flowers", nrow(nflow)))
colnames(nflow)[ncol(nflow)] = "trait"


height<-as.data.frame(s_height)
height <- cbind(height,rep("height", nrow(height)))
colnames(height)[ncol(height)] = "trait"


bush<-as.data.frame(s_bush)
bush <- cbind(bush,rep("bushiness", nrow(bush)))
colnames(bush)[ncol(bush)] = "trait"


tflow<-as.data.frame(s_tflow)
colnames(tflow)[1] <- "Chisq"
tflow <- cbind(tflow,rep("time to flower", nrow(tflow)))
colnames(tflow)[ncol(tflow)] = "trait"


#iheight<-as.data.frame(s_iheight)

df_anovas <- rbind(surv,
      flow,
      nflow,
      tflow,
      height,
      bush)

df_anovas$"Pr(>Chisq)"<- round(df_anovas$"Pr(>Chisq)", 4)
df_anovas$"Chisq"<- round(df_anovas$"Chisq", 2)

df_anovas

#write.csv(df_anovas, "../tables/df_anovas_traits_delete.csv")

```





## Group comparisons of predicted means & plotting


Plotting settings

```{r}

my_theme<-theme(axis.text=element_text(size=12),
        axis.title = element_text(size = 14),
        legend.text=element_text(size=10),
        legend.title = element_text(size=12),
        plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.title.x = element_text(hjust = 0.5))

pd = position_dodge(0.9)
alpha_raw_points = 0.15

trt_order <- c("control", "early drought", "late drought")

Dataset$trt <- factor(Dataset$trt,
    levels = trt_order,ordered = TRUE)

```




### ----- Survival - all levels

Compute emmeans and CI

```{r}

marginal_surv1.1 = emmeans(glmer_surv_nc,
                   ~ colors:trt,  calc = c(n = ".wgt."))

back.emmeans_surv<-confint(marginal_surv1.1, type = "response")

```
Add letter display from tukey tests

```{r}


surv_emmeans_cld <- multcomp::cld(object = marginal_surv1.1,
                           Letters = letters)


surv_emmeans_cld <- surv_emmeans_cld %>% 
  arrange(colors) %>% 
  dplyr::select(trt, .group, colors)


back.emmeans_surv_all <- left_join(back.emmeans_surv, surv_emmeans_cld, by = c("trt","colors"))

back.emmeans_surv_all

```



```{r}


Dataset_percentage <- aggregate(survived ~ trt + colors, data = Dataset, FUN = mean)

Dataset_percentage$trt <- factor(Dataset_percentage$trt,
   levels = trt_order,ordered = TRUE)



# Plotting raw data points
surv_raw <- ggdotchart(
  Dataset_percentage, 
  x = "trt", 
  y = "survived",
  color = "colors", 
  palette = c("black", "black", "black"), 
  alpha = 0.3,
  size = 5, 
  shape = 21,
  #add = "segment", 
  #add.params = list(color = "lightgray", size = 1.3),
  position = position_dodge(0.6),
  ggtheme = theme_classic(),
  sorting = "none",
  order = trt_order
)

# Overlay emmeans and CI on the raw data plot
surv_overlay_plot <- surv_raw +
  geom_errorbar(
    data = back.emmeans_surv,
    aes(
      x = trt, #factor(trt, levels = trt_order), 
      y = prob,  # Assuming prob is the probability in decimal form
      ymin = asymp.LCL,
      ymax = asymp.UCL,
      color = colors
    ),
    position = position_dodge(width = 0.6),
    width = 0.3,
    size = 1
  ) +
  geom_point(
    data = back.emmeans_surv,
    aes(
      x = trt, #factor(trt, levels = trt_order), 
      y = prob,  # Assuming prob is the probability in decimal form
      color = colors
    ),
    position = position_dodge(width = 0.6),
    size = 3,
    alpha = 0.5,
    shape = 15
  ) +
 #geom_text(
  #  data = back.emmeans_surv,
  #  aes(
  #    x = trt, # Adjust position based on factor levels,
  #    color = colors,
  #    y = asymp.UCL + 0.02,  # Adjust the position of the letters
 #     label = .group  # Use the .group column for labels
 #   ),
 #   position = position_dodge(width = 0.6),
 #   vjust = -0.5,  # Adjust vertical position
 #   size = 4
 # ) +
  scale_fill_manual(values = c("#990099", "#FF6666", "gold")) +
  scale_color_manual(
    values = c("#990099", "#FF6666", "gold"),  # Remove black color
    labels = c("pseudomajus", "F1 Hybrid", "striatum")  # Update labels
  ) +
  ylim(0,1.05)+
  theme_classic() +
  my_theme +
  guides(fill = FALSE) +
  #labs(color = "Phenotype") +
  theme(legend.position = "none") +
  xlab(NULL) +
  ylab("survival probability") +
  theme(axis.title.y = element_text(margin = margin(r = 10)))


surv_overlay_plot

# First, ensure you're using the joined data frame with .group letters
back.emmeans_surv_all$label_y <- back.emmeans_surv_all$asymp.UCL + 0.05  # Small vertical offset

# Add this to your plot
surv_overlay_plot <- surv_overlay_plot +
  geom_text(
    data = back.emmeans_surv_all,
    aes(
      x = trt,
      y = label_y,
      label = .group,
      color = colors
    ),
    position = position_dodge(width = 0.6),
    vjust = 0,
    size = 4
  )




```




### ----- Survival - significant levels

Compute emmeans and CI

```{r}

marginal_surv1.1 = emmeans(glmer_surv_nc,
                   ~ colors,  calc = c(n = ".wgt."))

back.emmeans_surv<-confint(marginal_surv1.1, type = "response")

```
Add letter display from tukey tests

```{r}


surv_emmeans_cld <- multcomp::cld(object = marginal_surv1.1,
                           Letters = letters)


surv_emmeans_cld <- surv_emmeans_cld %>% 
  arrange(colors) %>% 
  dplyr::select(.group, colors)


back.emmeans_surv <- left_join(back.emmeans_surv, surv_emmeans_cld, by = c("colors"))

back.emmeans_surv

```



```{r}


Dataset_percentage <- aggregate(survived ~ colors, data = Dataset, FUN = mean)



# Plotting raw data points
surv_raw <- ggdotchart(
  Dataset_percentage, 
  x = "colors", 
  y = "survived",
  color = "colors", 
  palette = c("black", "black", "black"), 
  alpha = 0.3,
  size = 5, 
  shape = 21,
  #add = "segment", 
  #add.params = list(color = "lightgray", size = 1.3),
  position = position_dodge(0.6),
  ggtheme = theme_classic(),
  sorting = "none"
)

# Overlay emmeans and CI on the raw data plot
surv_overlay_plot2 <- surv_raw +
  geom_errorbar(
    data = back.emmeans_surv,
    aes(
      x = colors, #factor(trt, levels = trt_order), 
      y = prob,  # Assuming prob is the probability in decimal form
      ymin = asymp.LCL,
      ymax = asymp.UCL,
      color = colors
    ),
    position = position_dodge(width = 0.6),
    width = 0.3,
    size = 1
  ) +
  geom_point(
    data = back.emmeans_surv,
    aes(
      x = colors, #factor(trt, levels = trt_order), 
      y = prob,  # Assuming prob is the probability in decimal form
      color = colors
    ),
    position = position_dodge(width = 0.6),
    size = 3,
    alpha = 0.5,
    shape = 15
  ) +
 geom_text(
    data = back.emmeans_surv,
    aes(
      x = colors, # Adjust position based on factor levels,
      color = colors,
     y = asymp.UCL + 0.02,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.6),
   vjust = -0.5,  # Adjust vertical position
   size = 4
  ) +
  scale_fill_manual(values = c("#990099", "#FF6666", "gold")) +
  scale_color_manual(
    values = c("#990099", "#FF6666", "gold"),  # Remove black color
   # labels = c("pseudomajus", "F1 Hybrid", "striatum")  # Update labels
  ) +
  ylim(0,1.05)+
  theme_classic() +
  my_theme +
  guides(fill = FALSE) +
  theme(legend.position = "none") +
  ylab("survival probability") +
  xlab(NULL)+
  theme(axis.title.y = element_text(margin = margin(r = 10)))+
   scale_x_discrete(guide = guide_axis(n.dodge=2),
                    labels = c("pseudomajus", "F1 Hybrid", "striatum"))


surv_overlay_plot2






```



### ----- Flowering - All levels


Compute emmeans and CI

```{r}
emmeans_flowering = emmeans(glmer_f,
                   ~ colors:trt,  calc = c(n = ".wgt."))

back.emmeans_flowering<-confint(emmeans_flowering, type = "response")

```

Add letter display from tukey tests

```{r}


flow_emmeans_cld <- multcomp::cld(object = emmeans_flowering,
                           Letters = letters)

flow_emmeans_cld <- flow_emmeans_cld %>% 
  arrange(trt, colors) %>% 
  dplyr::select(.group, colors, trt)


back.emmeans_flowering_all <- left_join(back.emmeans_flowering, flow_emmeans_cld, by = c("trt", "colors"))

back.emmeans_flowering_all

```


```{r}

Dataset_percentage <- aggregate(flowering ~ trt + colors, data = Dataset, FUN = mean)


# Plotting raw data points
flow_raw <- ggdotchart(
  Dataset_percentage, 
  x = "trt", 
  y = "flowering",
  color = "colors", 
  palette = c("black", "black", "black"), 
  alpha = 0.3,
  size = 5, 
  shape = 21,
  #add = "segment", 
  #add.params = list(color = "lightgray", size = 1.3),
  position = position_dodge(0.6),
  ggtheme = theme_classic(),
    sorting = "none",
  order = trt_order
)

# Overlay emmeans and CI on the raw data plot
flow_overlay_plot <- flow_raw +
  geom_errorbar(
    data = back.emmeans_flowering,
    aes(
      x = trt, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
      ymin = asymp.LCL,
      ymax = asymp.UCL,
      color = colors
    ),
    position = position_dodge(width = 0.6),
    width = 0.3,
    size = 1
  ) +
  geom_point(
    data = back.emmeans_flowering,
    aes(
      x = trt, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
      color = colors
    ),
    position = position_dodge(width = 0.6),
    size = 3,
    alpha = 0.5,
    shape = 15
  ) +
 # geom_text(
 #   data = back.emmeans_flowering,
 #   aes(
 #     x = trt, # Adjust position based on factor levels,
  #    color = colors,
  #    y = asymp.UCL + 0.02,  # Adjust the position of the letters
  #    label = .group  # Use the .group column for labels
 #   ),
 #   position = position_dodge(width = 0.6),
 #   vjust = -0.5,  # Adjust vertical position
 #   size = 4
#  ) +
  scale_fill_manual(values = c("#990099", "#FF6666", "gold")) +
  scale_color_manual(
    values = c("#990099", "#FF6666", "gold"),  # Remove black color
    labels = c("pseudomajus", "F1 Hybrid", "striatum")  # Update labels
  ) +
  ylim(0, 1.05)+
  theme_classic() +
  my_theme +
  guides(fill = FALSE) +
  #labs(color = "Phenotype") +
  theme(legend.position = "none")+
  xlab(NULL) +
  ylab("flowering probability") +
  theme(axis.title.y = element_text(margin = margin(r = 10)))


flow_overlay_plot

```


### ----- Flowering - significant levels

#### colors

Compute emmeans and CI

```{r}
emmeans_flowering = emmeans(glmer_f,
                   ~ colors,  calc = c(n = ".wgt."))

back.emmeans_flowering<-confint(emmeans_flowering, type = "response")

```

Add letter display from tukey tests

```{r}


flow_emmeans_cld <- multcomp::cld(object = emmeans_flowering,
                           Letters = letters)

flow_emmeans_cld <- flow_emmeans_cld %>% 
  arrange(colors) %>% 
  dplyr::select(.group, colors)


back.emmeans_flowering <- left_join(back.emmeans_flowering, flow_emmeans_cld, by = "colors")

back.emmeans_flowering

```


```{r}

Dataset_percentage <- aggregate(flowering ~ colors, data = Dataset, FUN = mean)


# Plotting raw data points
flow_raw <- ggdotchart(
  Dataset_percentage, 
  x = "colors", 
  y = "flowering",
  color = "colors", 
  palette = c("black", "black", "black"), 
  alpha = 0.3,
  size = 5, 
  shape = 21,
  #add = "segment", 
  #add.params = list(color = "lightgray", size = 1.3),
  position = position_dodge(0.6),
  ggtheme = theme_classic(),
    sorting = "none"
)

# Overlay emmeans and CI on the raw data plot
flow_overlay_plot2 <- flow_raw +
  geom_errorbar(
    data = back.emmeans_flowering,
    aes(
      x = colors, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
      ymin = asymp.LCL,
      ymax = asymp.UCL,
      color = colors
    ),
    position = position_dodge(width = 0.6),
    width = 0.3,
    size = 1
  ) +
  geom_point(
    data = back.emmeans_flowering,
    aes(
      x = colors, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
      color = colors
    ),
    position = position_dodge(width = 0.6),
    size = 3,
    alpha = 0.5,
    shape = 15
  ) +
  geom_text(
    data = back.emmeans_flowering,
    aes(
      x = colors, # Adjust position based on factor levels,
      color = colors,
      y = asymp.UCL + 0.02,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.6),
    vjust = -0.5,  # Adjust vertical position
    size = 4
 ) +
  scale_fill_manual(values = c("#990099", "#FF6666", "gold")) +
  scale_color_manual(
    values = c("#990099", "#FF6666", "gold"),  # Remove black color
    labels = c("pseudomajus", "F1 Hybrid", "striatum")  # Update labels
  ) +
  ylim(0, 1.05)+
  theme_classic() +
  my_theme +
  guides(fill = FALSE) +
  #labs(color = "Phenotype") +
  theme(legend.position = "none") + 
  xlab(NULL) +
  ylab("flowering probability") +
  theme(axis.title.y = element_text(margin = margin(r = 10)))+
   scale_x_discrete(guide = guide_axis(n.dodge=2),
                    labels = c("pseudomajus", "F1 Hybrid", "striatum"))


flow_overlay_plot2

```


#### trt

Compute emmeans and CI

```{r}
emmeans_flowering = emmeans(glmer_f,
                   ~ trt,  calc = c(n = ".wgt."))

back.emmeans_flowering<-confint(emmeans_flowering, type = "response")

```

Add letter display from tukey tests

```{r}


flow_emmeans_cld <- multcomp::cld(object = emmeans_flowering,
                           Letters = letters)

flow_emmeans_cld <- flow_emmeans_cld %>% 
  arrange(trt) %>% 
  dplyr::select(.group, trt)


back.emmeans_flowering <- left_join(back.emmeans_flowering, flow_emmeans_cld, by = "trt")

back.emmeans_flowering

```


```{r}

Dataset_percentage <- aggregate(flowering ~ trt, data = Dataset, FUN = mean)


# Plotting raw data points
flow_raw <- ggdotchart(
  Dataset_percentage, 
  x = "trt", 
  y = "flowering",
  #color = "colors", 
  palette = c("black", "black", "black"), 
  alpha = 0.3,
  size = 5, 
  shape = 21,
  #add = "segment", 
  #add.params = list(color = "lightgray", size = 1.3),
  position = position_dodge(0.6),
  ggtheme = theme_classic(),
    sorting = "none"
)

# Overlay emmeans and CI on the raw data plot
flow_overlay_plot3 <- flow_raw +
  geom_errorbar(
    data = back.emmeans_flowering,
    aes(
      x = trt, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
      ymin = asymp.LCL,
      ymax = asymp.UCL,
    #  color = colors
    ),
    position = position_dodge(width = 0.6),
    width = 0.3,
    size = 1
  ) +
  geom_point(
    data = back.emmeans_flowering,
    aes(
      x = trt, #factor(trt, levels = c(trt_order)), 
      y = prob,  # Assuming prob is the probability in decimal form
   #   color = colors
    ),
    position = position_dodge(width = 0.6),
    size = 3,
    alpha = 0.5,
    shape = 15
  ) +
  geom_text(
    data = back.emmeans_flowering,
    aes(
      x = trt, # Adjust position based on factor levels,
     # color = colors,
      y = asymp.UCL + 0.02,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.6),
    vjust = -0.5,  # Adjust vertical position
    size = 4
 ) +
 # scale_fill_manual(values = c("#990099", "#FF6666", "gold")) +
 # scale_color_manual(
#    values = c("#990099", "#FF6666", "gold"),  # Remove black color
#    labels = c("pseudomajus", "F1 Hybrid", "striatum")  # Update labels
#  ) +
  ylim(0, 1.05)+
  theme_classic() +
  my_theme +
  guides(fill = FALSE) +
  labs(color = "Phenotype") +
  xlab(NULL) +
  ylab("flowering probability") +
  theme(axis.title.y = element_text(margin = margin(r = 10)))+
   scale_x_discrete(guide = guide_axis(n.dodge=2))


flow_overlay_plot3

```


### ----- N flowers - All levels

Compute emmeans and CI


```{r}
### N flowers (1 drought level) - treatment significant

marginal_nf.d = emmeans(glmer_nf_d,
                   ~ colors:trt,  calc = c(n = ".wgt."))

back.emmeans_nflow<-confint(marginal_nf.d, type = "response")


back.emmeans_nflow[which(is.infinite(back.emmeans_nflow$asymp.UCL)),"asymp.UCL"] <- 0

```



Add letter display from tukey tests

```{r}


nflow_emmeans_cld <- multcomp::cld(object = marginal_nf.d,
                           Letters = letters)

nflow_emmeans_cld <- nflow_emmeans_cld %>% 
  arrange(trt, colors) %>% 
  dplyr::select(.group, colors, trt)


back.emmeans_nflow_all <- left_join(back.emmeans_nflow, nflow_emmeans_cld, by = c("trt", "colors"))

back.emmeans_nflow_all

```





```{r}


nflow_raw <- ggplot(Dataset, aes(x = trt, y = flower_count, group = colors)) +
  geom_jitter(
    aes(color = "black", fill = "black"),
    position = position_jitterdodge(0.08),
    size = 1.2,
    alpha = alpha_raw_points
  ) +
  scale_fill_manual(values=c("black", "black", "black"))+
  scale_color_manual(values=c("black", "black", "black"))+
  theme_classic() +
  my_theme

  



# Overlay emmeans and CI on the raw data plot
nflow_overlay_plot <- nflow_raw +
  geom_errorbar(
    data = back.emmeans_nflow,
    aes(x = trt, y = response, ymin = asymp.LCL, ymax = asymp.UCL, color = colors),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = back.emmeans_nflow,
    aes(x = trt, y = response, color = colors),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  ) +
#  geom_text(
 #   data = back.emmeans_nflow,
 #   aes(
 #     x = trt, # Adjust position based on factor levels,
 #     color = colors,
 #     y = asymp.UCL + 0.1,  # Adjust the position of the letters
 #     label = .group  # Use the .group column for labels
  #  ),
 #   position = position_dodge(width = 0.75),
 #   vjust = -0.5,  # Adjust vertical position
 #   size = 4
#  ) +
    scale_fill_manual(values=c("#990099", "#FF6666", "gold"))+
  scale_color_manual(values=c("#990099", "#FF6666", "gold","black"),labels = c("raw data", "pseudomajus", "F1 hybrid", "striatum"))+
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
#labs(color = "phenotype")+
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("pseudomajus", "F1 Hybrid", "striatum")) + 
  xlab(NULL)+
  ylab("flower count")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))
  

nflow_overlay_plot


```


### ----- N flowers - significant levels


#### colors

Compute emmeans and CI


```{r}
### N flowers (1 drought level) - treatment significant

marginal_nf.d = emmeans(glmer_nf_d,
                   ~ colors,  calc = c(n = ".wgt."))

back.emmeans_nflow<-confint(marginal_nf.d, type = "response")


back.emmeans_nflow[which(is.infinite(back.emmeans_nflow$asymp.UCL)),"asymp.UCL"] <- 0

```



Add letter display from tukey tests

```{r}


nflow_emmeans_cld <- multcomp::cld(object = marginal_nf.d,
                           Letters = letters)

nflow_emmeans_cld <- nflow_emmeans_cld %>% 
  arrange(colors) %>% 
  dplyr::select(.group, colors)


back.emmeans_nflow <- left_join(back.emmeans_nflow, nflow_emmeans_cld, by =  "colors")

# we manually assign a different letter to hybrids because they have 0 flowers

back.emmeans_nflow[back.emmeans_nflow$colors == "M_Y", ".group"] <- "b"

back.emmeans_nflow

```





```{r}



# Overlay emmeans and CI on the raw data plot
nflow_overlay_plot2 <- ggplot(back.emmeans_nflow, aes(x = colors, y = response, group = colors)) +
  #nflow_raw +
  geom_errorbar(
    data = back.emmeans_nflow,
    aes(x = colors, y = response, ymin = asymp.LCL, ymax = asymp.UCL, color = colors),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = back.emmeans_nflow,
    aes(x = colors, y = response, color = colors),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  ) +
 geom_text(
    data = back.emmeans_nflow,
    aes(
      x = colors, # Adjust position based on factor levels,
      color = colors,
      y = asymp.UCL + 0.1,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.75),
    vjust = -0.5,  # Adjust vertical position
    size = 4
  ) +
    scale_fill_manual(values=c("#990099", "#FF6666", "gold"))+
  scale_color_manual(values=c("#990099", "#FF6666", "gold"),labels = c("pseudomajus", "F1 hybrid", "striatum"))+
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
#labs(color = "phenotype")+
  theme(legend.position = "none") + 
  xlab(NULL)+
  ylab("flower count")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))+
   scale_x_discrete(guide = guide_axis(n.dodge=2),
                    labels = c("pseudomajus", "F1 Hybrid", "striatum"))
  

nflow_overlay_plot2


```






#### trt

Compute emmeans and CI


```{r}
### N flowers (1 drought level) - treatment significant

marginal_nf.d = emmeans(glmer_nf_d,
                   ~ trt,  calc = c(n = ".wgt."))

back.emmeans_nflow<-confint(marginal_nf.d, type = "response")


back.emmeans_nflow[which(is.infinite(back.emmeans_nflow$asymp.UCL)),"asymp.UCL"] <- 0

```



Add letter display from tukey tests

```{r}


nflow_emmeans_cld <- multcomp::cld(object = marginal_nf.d,
                           Letters = letters)

nflow_emmeans_cld <- nflow_emmeans_cld %>% 
  arrange(trt) %>% 
  dplyr::select(.group, trt)


back.emmeans_nflow <- left_join(back.emmeans_nflow, nflow_emmeans_cld, by =  "trt")

# manually assign different letter to late drought

back.emmeans_nflow[back.emmeans_nflow$trt == "late drought", ".group"] <- "c"

back.emmeans_nflow

```





```{r}



# Overlay emmeans and CI on the raw data plot
nflow_overlay_plot3 <- ggplot(back.emmeans_nflow, aes(x = trt, y = response)) +
  #nflow_raw +
  geom_errorbar(
    data = back.emmeans_nflow,
    aes(x = trt, y = response, ymin = asymp.LCL, ymax = asymp.UCL),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = back.emmeans_nflow,
    aes(x = trt, y = response),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  ) +
 geom_text(
    data = back.emmeans_nflow,
    aes(
      x = trt, # Adjust position based on factor levels,
      y = asymp.UCL + 0.1,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.75),
    vjust = -0.5,  # Adjust vertical position
    size = 4
  ) +
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
labs(color = "phenotype")+
  xlab(NULL)+
  ylab("flower count")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))+
   scale_x_discrete(guide = guide_axis(n.dodge=2))
  

nflow_overlay_plot3


```









### ----- Height


```{r}

emmeans_height = emmeans(lmer_height,
                   ~ colors:trt,  calc = c(n = ".wgt."))

emmeans_height <- multcomp::cld(object = emmeans_height,
                                   Letters = letters)

```




RAW DATA



```{r}


height_raw <- ggplot(Dataset, aes(x = trt, y = height_cm, group = colors)) +
  geom_jitter(
    aes(color = "black", fill = "black"),
    position = position_jitterdodge(0.08),
    size = 1.2,
    alpha = alpha_raw_points
  ) +
  scale_fill_manual(values=c("black", "black", "black"))+
  scale_color_manual(values=c("black", "black", "black"))+
  theme_classic() +
  my_theme

  



# Overlay emmeans and CI on the raw data plot
height_overlay_plot <- height_raw +
  geom_errorbar(
    data = emmeans_height,
    aes(x = trt, y = emmean, ymin = lower.CL, ymax = upper.CL, color = colors),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = emmeans_height,
    aes(x = trt, y = emmean, color = colors),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  ) +
  geom_text(
    data = emmeans_height,
    aes(
      x = trt, # Adjust position based on factor levels,
      color = colors,
      y = upper.CL + 0.1,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.75),
    vjust = -0.5,  # Adjust vertical position
    size = 4
  ) +
    scale_fill_manual(values=c("#990099", "#FF6666", "gold"))+
  scale_color_manual(values=c("#990099", "#FF6666", "gold","black"),labels = c("raw data", "pseudomajus", "F1 hybrid", "striatum"))+
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
labs(color = "phenotype")+
  xlab(NULL)+
  ylab("height (cm)")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))
  

height_overlay_plot


```



### ----- Bushiness

Compute emmeans and CI

```{r}
emmeans_bush = emmeans(glmer_bush,
                   ~ colors:trt,  calc = c(n = ".wgt."))

back.emmeans_bush<-confint(emmeans_bush, type = "response")


```


Add letter display from tukey tests

```{r}

emmeans_bush_cld <- multcomp::cld(object = emmeans_bush,
                                   Letters = letters)

emmeans_bush_cld <- emmeans_bush_cld %>% 
  arrange(trt, colors) %>% 
  dplyr::select(.group, colors, trt)


back.emmeans_bush <- left_join(back.emmeans_bush, emmeans_bush_cld, by = c("trt", "colors"))

back.emmeans_bush

```




```{r}


bush_raw <- ggplot(Dataset, aes(x = trt, y = bushiness, group = colors)) +
  geom_jitter(
    aes(color = "black", fill = "black"),
    position = position_jitterdodge(0.08),
    size = 1.2,
    alpha = alpha_raw_points
  ) +
  scale_fill_manual(values=c("black", "black", "black"))+
  scale_color_manual(values=c("black", "black", "black"))+
  theme_classic() +
  my_theme

  



# Overlay emmeans and CI on the raw data plot
bushiness_overlay_plot <- bush_raw +
  geom_errorbar(
    data = back.emmeans_bush,
    aes(x = trt, y = rate, ymin = asymp.LCL, ymax = asymp.UCL, color = colors),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = back.emmeans_bush,
    aes(x = trt, y = rate, color = colors),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  ) +
  geom_text(
    data = back.emmeans_bush,
    aes(
      x = trt, # Adjust position based on factor levels,
      color = colors,
      y = asymp.UCL + 0.1,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.75),
    vjust = -0.5,  # Adjust vertical position
    size = 4
  ) +
    scale_fill_manual(values=c("#990099", "#FF6666", "gold"))+
  scale_color_manual(values=c("#990099", "#FF6666", "gold","black"),labels = c("pseudomajus", "F1 hybrid", "striatum", "raw data"))+
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
labs(color = "phenotype")+
  xlab(NULL)+
  ylab("bushiness (n nodes)")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))
  

bushiness_overlay_plot


```





### ----- Time to flower


Compute emmeans and CI

```{r}
emmeans_tflow = emmeans(glmer_tf,
                   ~ colors:trt,  calc = c(n = ".wgt."))

back.emmeans_tflow<-confint(emmeans_tflow, type = "response")

```


Add letter display from tukey tests

```{r}

emmeans_tflow_cld <- multcomp::cld(object = emmeans_tflow,
                                   Letters = letters)

emmeans_tflow_cld <- emmeans_tflow_cld %>% 
  arrange(trt, colors) %>% 
  dplyr::select(.group, colors, trt)


back.emmeans_tflow <- left_join(back.emmeans_tflow, emmeans_tflow_cld, by = c("trt", "colors"))

back.emmeans_tflow

```






```{r}
tflow_raw <- ggplot(Dataset, aes(x = trt, y = days_1flower, group = colors)) +
  geom_jitter(
    aes(color = "black", fill = "black"),
    position = position_jitterdodge(0.08),
    size = 1.2,
    alpha = alpha_raw_points
  ) +
  scale_fill_manual(values=c("black", "black", "black"))+
  scale_color_manual(values=c("black", "black", "black"))+
  theme_classic() +
  my_theme

  



# Overlay emmeans and CI on the raw data plot
tflow_overlay_plot <- tflow_raw +
  geom_errorbar(
    data = back.emmeans_tflow,
    aes(x = trt, y = response, ymin = asymp.LCL, ymax = asymp.UCL, color = colors),
    position = position_dodge(width = 0.75),
    width = 0.3,
    size = 1
  ) +
  
  geom_point(
    data = back.emmeans_tflow,
    aes(x = trt, y = response, color = colors),
    position = position_dodge(width = 0.75),
    size = 3,
    alpha = 0.5,
    shape = 15
    
  )  +
  geom_text(
    data = back.emmeans_tflow,
    aes(
      x = trt, # Adjust position based on factor levels,
      color = colors,
      y = asymp.UCL + 0.1,  # Adjust the position of the letters
      label = .group  # Use the .group column for labels
    ),
    position = position_dodge(width = 0.75),
    vjust = -0.5,  # Adjust vertical position
    size = 4
  ) +
    scale_fill_manual(values=c("#990099", "#FF6666", "gold"))+
  scale_color_manual(values=c("#990099", "#FF6666", "gold","black"),labels = c("pseudomajus", "F1 hybrid", "striatum", "raw data"))+
  theme_classic()+
  my_theme+
guides(fill = FALSE)+
labs(color = "phenotype")+
  ylim(38,95)+
  xlab(NULL)+
  ylab("time to flower (days)")+
  theme(axis.title.y = element_text(margin = margin(r = 10)))

tflow_overlay_plot

```




# Fig 1

```{r}

arranged_flowering_coltrt <- ggarrange(
  
  flow_overlay_plot2 + ylab(NULL), flow_overlay_plot3 + ylab(NULL),
  
  ncol = 2,
  nrow = 1,
  
  labels = c("C", "D")
)


arranged_nflow_coltrt <- ggarrange(
  
  nflow_overlay_plot2 + ylab(NULL) + ylim(0,1.8), nflow_overlay_plot3 + ylab(NULL) +ylim(0,6.5),
  
  ncol = 2,
  nrow = 1,
  
  labels = c("F", "G")
)





# Define spacer for empty cells
white_spacer <- ggplot() + theme_void() + theme(plot.background = element_rect(fill = "white", color = NA))

# Rebuild the layout
figure1 <- ggarrange(
  
  # First row: survival plot on left, empty on right
  surv_overlay_plot +
    theme(axis.title.y = element_text(margin = margin(r = 10))) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  labs(color = "Morphotype"),
  white_spacer,
  
  # Second row: flowering prob plots
  flow_overlay_plot +
    ylab("flowering prob. (all plants)") +
    theme(axis.title.y = element_text(margin = margin(r = 10))) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)),
  arranged_flowering_coltrt,
  
  # Third row: flower count plots
  nflow_overlay_plot +
    ylab("flower count (survivors)") +
    theme(axis.title.y = element_text(margin = margin(r = 10))) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)),
  arranged_nflow_coltrt,
  
  # Fourth row: height plot on left, empty on right
  height_overlay_plot +
    ylab("height (cm)") +
    theme(axis.title.y = element_text(margin = margin(r = 10))) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)),
  white_spacer,
  
  nrow = 4,
  ncol = 2,
  common.legend = TRUE,
  labels = c("A", "", "B", "", "E", "", "H", "")
)

# Save the figure
#ggsave("../figures/figure1a_01aug.png", figure1, height = 12.5, width = 10)


```




```{r}

figure_2_a <- ggarrange(
  
    surv_overlay_plot,

flow_overlay_plot,

nflow_overlay_plot,

nrow = 3,
ncol = 1,

common.legend = TRUE,

labels = c("A", "B", "C")
  
)


figure_2_a


#ggsave("../figures/figure_1.png", height = 8, width = 5)

```




```{r}


# Update legend title in both plots
bushiness_overlay_plot <- bushiness_overlay_plot +
  labs(color = "morphotype", fill = "morphotype")  # depending on your legend mapping

tflow_overlay_plot <- tflow_overlay_plot +
  labs(color = "morphotype", fill = "morphotype")

# Combine with ggarrange
figure_2_b <- ggarrange(
  bushiness_overlay_plot,
  tflow_overlay_plot,
  nrow = 2,
  ncol = 1,
  common.legend = TRUE,
  legend = "right",
  labels = c("A", "B")
)

figure_2_b


#ggsave("../figures/figure_s1a.png", height = 6.5, width = 8)

```




## save emmeans results

```{r}

options(scipen = 999)

colmnames_anova <- c("colors", "trt", "estimated response", "SE", "df", "n",
                     "lower CI", "upper CI", "comp" ,"trait")

df_anova_surv <- as.data.frame(back.emmeans_surv_all)
df_anova_surv$trait <- rep("survival", nrow(df_anova_surv))
colnames(df_anova_surv) = colmnames_anova

df_anova_flow <- as.data.frame(back.emmeans_flowering_all)
df_anova_flow$trait <- rep("flowering", nrow(df_anova_flow))
colnames(df_anova_flow) = colmnames_anova

df_anova_nflow <- as.data.frame(back.emmeans_nflow_all)
df_anova_nflow$trait <- rep("n flowers", nrow(df_anova_nflow))
colnames(df_anova_nflow) = colmnames_anova
 
df_anova_height <- as.data.frame(emmeans_height)
df_anova_height$trait <- rep("height (cm)", nrow(df_anova_height))
colnames(df_anova_height) = colmnames_anova

df_anova_bush <- as.data.frame(back.emmeans_bush)
df_anova_bush$trait <- rep("bushiness (n nodes)", nrow(df_anova_bush))
colnames(df_anova_bush) = colmnames_anova

df_anova_tflow <- as.data.frame(back.emmeans_tflow)
df_anova_tflow$trait <- rep("time to flower (days)", nrow(df_anova_tflow))
colnames(df_anova_tflow) = colmnames_anova

df_anovas <- do.call("rbind", list(df_anova_surv, 
                      df_anova_flow, 
                      df_anova_nflow,
                      df_anova_height,
                      df_anova_bush,
                      df_anova_tflow))

df_anovas_clean <- do.call("rbind", lapply(
  list(
    df_anova_surv, 
    df_anova_flow, 
    df_anova_nflow,
    df_anova_height,
    df_anova_bush,
    df_anova_tflow
  ), 
  function(x) {
    x_clean <- as.data.frame(x)
    class(x_clean) <- "data.frame"  # Remove "summary_emm"
    x_clean
  }
))


df_anovas_clean$`estimated response` <- round(df_anovas$`estimated response`, 2)
df_anovas_clean$`lower CI` <- round(df_anovas$`lower CI`, 2)
df_anovas_clean$`upper CI` <- round(df_anovas$`upper CI`, 2)

df_anovas_clean

df_anovas_clean$CI <- paste0(
  format(round(df_anovas_clean$`lower CI`, 2), nsmall = 2), "-",
  format(round(df_anovas_clean$`upper CI`, 2), nsmall = 2)
)

```



## summaries


###############
time to flower drought-control

```{r}

# Filter for time to flower and extract estimates by treatment and color
df_flowering_time <- df_anovas_clean %>%
  filter(trait == "time to flower (days)")

# Compute average time to flower across morphotypes per treatment
avg_time_by_trt <- df_flowering_time %>%
  group_by(trt) %>%
  summarise(mean_time = mean(`estimated response`))

# View raw differences in days compared to control
control_time <- avg_time_by_trt %>% filter(trt == "control") %>% pull(mean_time)

avg_time_by_trt <- avg_time_by_trt %>%
  mutate(diff_vs_control = mean_time - control_time)

avg_time_by_trt

```
time to flower, which was delayed by 2.9 days under early drought and accelerated by 7.5 days under late drought, relative to control conditions



###################
n flowers

```{r}
library(dplyr)

# Filter the data for the "n flowers" trait
df_flowers <- df_anovas_clean %>%
  filter(trait == "n flowers") %>%
  group_by(trt) %>%
  summarise(mean_n_flowers = mean(`estimated response`))

# Calculate difference from control
df_flowers <- df_flowers %>%
  mutate(diff_vs_control = mean_n_flowers - mean_n_flowers[trt == "control"])

df_flowers

```

Flower production declined sharply in drought treatments, with plants producing on average 3.8 fewer flowers under early drought and 3.85 fewer under late drought compared to control conditions


################
survival

```{r}
# Calculate mean survival for early and late drought
df_survival <- df_anovas_clean %>%
  filter(trait == "survival") %>%
  group_by(trt) %>%
  summarise(
    mean_survival = mean(`estimated response`, na.rm = TRUE)
  ) %>%
  mutate(
    control_survival = 1,
    diff_vs_control = mean_survival - control_survival
  )

df_survival

```

Compared to the control condition (survival probability = 1.0), survival declined by 0.27 under early drought and by 0.48 under late drought

###############
flowerin drought vs control

```{r}

# Filter flowering data
df_flowering <- df_anovas_clean %>%
  filter(trait == "flowering") %>%
  select(trt, estimated_response = `estimated response`)

# Calculate mean flowering probability by treatment
df_flowering_summary <- df_flowering %>%
  group_by(trt) %>%
  summarise(mean_flowering = mean(estimated_response)) %>%
  mutate(
    control_flowering = mean_flowering[trt == "control"],
    diff_vs_control = mean_flowering - control_flowering
  )

df_flowering_summary


```
Relative to the control (0.68), flowering probability declined by 0.46 under early drought and by 0.27 under late drought

################
survival hybrids compared to magenta and yellow

```{r}

library(dplyr)

# Filter only survival trait under early drought
diff_early_MM <- df_anovas_clean %>%
  filter(trait == "survival", trt == "early drought", colors %in% c("M_M", "M_Y")) %>%
  select(colors, `estimated response`) %>%
  tidyr::pivot_wider(names_from = colors, values_from = `estimated response`) %>%
  mutate(diff_vs_MM = M_Y - M_M)

# View result
diff_early_MM



```

```{r}

# Filter survival data under late drought for all morphotypes
diff_late_avg_parents <- df_anovas_clean %>%
  filter(trait == "survival", trt == "late drought", colors %in% c("M_M", "M_Y", "Y_Y")) %>%
  select(colors, `estimated response`) %>%
  pivot_wider(names_from = colors, values_from = `estimated response`) %>%
  mutate(
    avg_parents = (M_M + Y_Y) / 2,
    diff_vs_avg_parents = M_Y - avg_parents
  )

# View result
diff_late_avg_parents

```



##############
flowering hybrids compared to magenta and yellow

```{r}
library(dplyr)

# Filter to flowering data
df_flowering <- df_anovas_clean %>%
  filter(trait == "flowering")

# Pivot wider to compare morphotypes side by side
df_flowering_wide <- df_flowering %>%
  select(trt, colors, `estimated response`) %>%
  tidyr::pivot_wider(names_from = colors, values_from = `estimated response`) %>%
  rename(
    early_drought = trt
  )

# Calculate absolute differences in flowering probability
df_flowering_diffs <- df_flowering_wide %>%
  mutate(
    diff_vs_MM = M_Y - M_M,
    diff_vs_YY = M_Y - Y_Y
  )

# Optional: calculate mean difference across treatments
df_flowering_summary <- df_flowering_diffs %>%
  summarise(
    mean_diff_vs_MM = mean(diff_vs_MM, na.rm = TRUE),
    mean_diff_vs_YY = mean(diff_vs_YY, na.rm = TRUE)
  )

# View results
print(df_flowering_diffs)
print(df_flowering_summary)

```


##############
Reduction flowering prob from control to drought

```{r}

library(dplyr)
library(tidyr)

# Filter for the flowering trait
df_flowering <- df_anovas_clean %>%
  filter(trait == "flowering") %>%
  select(trt, colors, `estimated response`)

# Reshape to wide format
df_flowering_wide <- df_flowering %>%
  pivot_wider(names_from = trt, values_from = `estimated response`) %>%
  rename(
    early = `early drought`,
    late = `late drought`,
    control = control
  )

# Calculate raw differences in flowering probability
df_flowering_diff <- df_flowering_wide %>%
  mutate(
    diff_early = control - early,
    diff_late = control - late
  )

# Compute average reduction across morphotypes
df_flowering_summary <- df_flowering_diff %>%
  summarise(
    mean_diff_early = mean(diff_early, na.rm = TRUE),
    mean_diff_late = mean(diff_late, na.rm = TRUE)
  )

# Output the data
print(df_flowering_diff)
print(df_flowering_summary)



```
################
nflowers hybrids compared to parental in control and early drought

```{r}
library(dplyr)

# Filter only the relevant rows: trait == "n flowers" and trt in control or early drought
df_flowers <- df_anovas_clean %>%
  filter(trait == "n flowers", trt %in% c("control", "early drought")) %>%
  select(trt, colors, `estimated response`) %>%
  pivot_wider(names_from = colors, values_from = `estimated response`) %>%
  mutate(
    parental_avg = (M_M + Y_Y) / 2,
    hybrid_diff = M_Y - parental_avg
  )

# Print the result
df_flowers

```

###################
height  hybrids

```{r}
# Filter data for the trait "height (cm)"
df_height <- df_anovas_clean %>% 
  filter(trait == "height (cm)") %>%
  select(trt, colors, `estimated response`) %>%
  rename(response = `estimated response`)

# Spread the data to wide format for comparison
df_height_wide <- df_height %>%
  tidyr::pivot_wider(names_from = colors, values_from = response) %>%
  rename(M_M = `M_M`, M_Y = `M_Y`, Y_Y = `Y_Y`)

# Compare hybrid vs parental under control
df_height_wide <- df_height_wide %>%
  mutate(
    parental_avg = (M_M + Y_Y) / 2,
    hybrid_diff_vs_parental = M_Y - parental_avg
  )

# Compute drop in height from control to each drought treatment, per morphotype
df_height_drop <- df_height_wide %>%
  arrange(match(trt, c("control", "early drought", "late drought"))) %>%
  mutate(
    drop_M_M = M_M - M_M[trt == "control"],
    drop_M_Y = M_Y - M_Y[trt == "control"],
    drop_Y_Y = Y_Y - Y_Y[trt == "control"]
  )

# Show results
df_height_drop
```

```{r}
# Filter for "height (cm)" under control conditions
df_control_height <- df_anovas_clean %>%
  filter(trait == "height (cm)", trt == "control") %>%
  select(colors, `estimated response`) %>%
  rename(height = `estimated response`)

# Extract height values
height_MM <- df_control_height %>% filter(colors == "M_M") %>% pull(height)
height_MY <- df_control_height %>% filter(colors == "M_Y") %>% pull(height)
height_YY <- df_control_height %>% filter(colors == "Y_Y") %>% pull(height)

# Calculate differences
diff_vs_MM <- height_MY - height_MM
diff_vs_YY <- height_MY - height_YY
diff_vs_avg_parental <- height_MY - mean(c(height_MM, height_YY))

# Print results
cat("Hybrids were", round(diff_vs_MM, 2), "cm taller than M_M\n")
cat("Hybrids were", round(diff_vs_YY, 2), "cm taller than Y_Y\n")
cat("Hybrids were", round(diff_vs_avg_parental, 2), "cm taller than the average of both parentals\n")
```



#################

flowering time magentas

```{r}

# Subset to magenta morphotype and time to flower
df_mm <- df_anovas_clean %>%
  filter(colors == "M_M", trait == "time to flower (days)") %>%
  select(trt, estimated_response = `estimated response`)

# Pivot to wide format by treatment
df_mm_wide <- df_mm %>%
  pivot_wider(names_from = trt, values_from = estimated_response)

# Calculate difference in days: early drought - control
diff_early_vs_control <- df_mm_wide$`early drought` - df_mm_wide$control

# Print the result
diff_early_vs_control


```



##################

```{r}

# Define missing rows manually
df_survival_control <- data.frame(
  colors = factor(c("M_M", "M_Y", "Y_Y"), levels = levels(df_anovas_clean$colors)),
  trt = factor("control", levels = levels(df_anovas_clean$trt)),
  `estimated response` = 1,
  SE = NA,
  df = Inf,
  n = 18,
  "lower CI" = NA,
  "upper CI" = NA,
  comp = NA,
  trait = "survival",
  CI = "1-1"
)

# Fix column names to match df_anovas_clean
colnames(df_survival_control) <- colnames(df_anovas_clean)


# Add to original dataframe
df_anovas_filled <- bind_rows(df_anovas_clean, df_survival_control)


# Step 1: Average estimated values across morphotypes, per trait and treatment
df_trait_means <- df_anovas_filled %>%
  group_by(trait, trt) %>%
  summarise(mean_est = mean(`estimated response`, na.rm = TRUE), .groups = "drop")

# Step 2: Pivot to wide format (1 row per trait)
df_wide <- df_trait_means %>%
  pivot_wider(names_from = trt, values_from = mean_est)

# Step 3: Calculate % decrease from control
df_effects <- df_wide %>%
  mutate(
    early_drought_pct_decrease = round((control - `early drought`) / control * 100, 1),
    late_drought_pct_decrease  = round((control - `late drought`) / control * 100, 1)
  )

# Step 4: Print the result
print(df_effects)

```



```{r}
# All traits included now
overall_summary <- df_effects %>%
  summarise(
    mean_early = round(mean(early_drought_pct_decrease, na.rm = TRUE), 1),
    min_early  = round(min(early_drought_pct_decrease, na.rm = TRUE), 1),
    max_early  = round(max(early_drought_pct_decrease, na.rm = TRUE), 1),
    mean_late  = round(mean(late_drought_pct_decrease, na.rm = TRUE), 1),
    min_late   = round(min(late_drought_pct_decrease, na.rm = TRUE), 1),
    max_late   = round(max(late_drought_pct_decrease, na.rm = TRUE), 1)
  )

print(overall_summary)

```

Drought treatments affected all measured phenotypic traits, with an average reduction of 48.1% under early drought (range: â€“5.1% to 88.0%) and 44.1% under late drought (range: 13.4% to 89.1%; Table 1, S3, S4; Figure 2, S2). 



## % difference in flowering

```{r}
# Filter to flowering trait only
df_flowering <- df_anovas_clean %>%
  filter(trait == "flowering")

# Reshape the data to have one row per (treatment, morphotype) pair
df_wide <- df_flowering %>%
  select(trt, colors, flowering_prob = `estimated.response`) %>%
  filter(colors %in% c("M_M", "M_Y", "Y_Y")) %>%
  tidyr::pivot_wider(names_from = colors, values_from = flowering_prob)

# Calculate percent increase of hybrid compared to each parental morph
df_wide <- df_wide %>%
  mutate(
    pct_increase_vs_MM = ((M_Y - M_M) / M_M) * 100,
    pct_increase_vs_YY = ((M_Y - Y_Y) / Y_Y) * 100
  )

# View results
print(df_wide)
```



















